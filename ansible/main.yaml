- name: Instalar y configurar PostgreSQL con usuario y base de datos
  hosts: all
  become: yes
  vars:
    postgres_user: "userpostgres"  # Nombre del usuario que quieres crear
    postgres_password: "admin123" # Contraseña para el usuario
    db_name: "dbprueba"           # Nombre de la base de datos
  tasks:
    - name: Actualizar el índice de paquetes
      apt:
        update_cache: yes

    - name: Instalar PostgreSQL y dependencias
      apt:
        name:
          - postgresql
          - postgresql-contrib
          - python3-psycopg2
        state: present

    - name: Asegurarse de que el servicio PostgreSQL está iniciado
      service:
        name: postgresql
        state: started
        enabled: yes

    - name: Crear usuario de PostgreSQL
      postgresql_user:
        name: "{{ postgres_user }}"
        password: "{{ postgres_password }}"
        priv: "ALL" # Asigna todos los privilegios al usuario
        state: present
      become_user: postgres

    - name: Crear base de datos
      postgresql_db:
        name: "{{ db_name }}"
        owner: "{{ postgres_user }}" # Asigna la base de datos al usuario creado
        state: present
      become_user: postgres
