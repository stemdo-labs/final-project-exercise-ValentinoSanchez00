name: selfhosted
on:
  workflow_call:

jobs:
  ssh:
    runs-on: ubuntu-latest
    steps:
      - name: Install SSH and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ssh sshpass curl tar shasum

      - name: Entrar a la m√°quina virtual
        env:
          SSH_USER: adminuser
          SSH_IP: 10.0.0.5
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_IP" << 'EOF'
            # Crear carpeta para el runner
            mkdir -p actions-runner && cd actions-runner

            # Descargar el paquete del runner
            curl -o actions-runner-linux-x64-2.320.0.tar.gz -L https://github.com/actions/runner/releases/download/v2.320.0/actions-runner-linux-x64-2.320.0.tar.gz

            # Validar el hash (opcional)
            echo "93ac17c7e743ee85b5d386f5c1787385ef07b3d7c728ff66ce0d3813d5f46900  actions-runner-linux-x64-2.320.0.tar.gz" | shasum -a 256 -c

            # Extraer el instalador
            tar xzf ./actions-runner-linux-x64-2.320.0.tar.gz

            # Configurar el runner
            ./config.sh --url https://github.com/stemdo-labs/final-project-exercise-ValentinoSanchez00 --token ${{ secrets.RUNNER_TOKEN }}

            # Iniciar el runner
            ./run.sh
          EOF
